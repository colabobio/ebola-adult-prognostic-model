---
title: "Model update"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
library(Hmisc)
library(rms)
library(glmnet)
library(tidyr)
library(dplyr)
library(purrr)
library(ROCit)
```

This notebook updates the model applying recalibration, and then adding one more predictor

```{r message=FALSE, cache=F}
source('./mdl-evaluation.R')
source('./mdl-selection.R')

num_imp <-100   # Number of multiple imputations
num_boot <- 200  # Number of bootstrap samples
random_seed <- 151  # Setting random seed for reproducibility
```

TODO:

* Remove children (<= 18)
data_adults <- data %>% filter(age >= 15 & age < 18)
v <- c('bun12', 'alt12', 'ast12', 'ck12', 'alb12', 'k12', 'cre12', 'crp12')

Comparing imputation vs complete case models
* Use data from prev day to train next

data_adults[v]
* K is bimodal - transform
Colinear groups:
  * BUN and CRE
  * ALT/AST 
  * AST/Ck/K
  * https://medium.com/analytics-vidhya/multicollinearity-ridge-lasso-elastic-net-regression-using-r-6582cbabf7f3
  * https://www.lexjansen.com/wuss/2018/131_Final_Paper_PDF.pdf


```{r}
# Load the data, remove children, and transform Ct values into Z-scores

data <- read.csv('data.csv')
data <- data %>% filter(age >= 15)

data$ct12 <- (data$ct12 - mean(data$ct12, na.rm=T))/sd(data$ct12, na.rm=T)
data$ct34 <- (data$ct34 - mean(data$ct34, na.rm=T))/sd(data$ct34, na.rm=T)
data$ct56 <- (data$ct56 - mean(data$ct56, na.rm=T))/sd(data$ct56, na.rm=T)
```

```{r}
# Construct the base prognostic model that only uses age and Ct in the first 48 hours

base_model <- function(df) {
  # Calculate the linear term in the logistic function of the model
  # p(x) = 1 / (1+exp(-lp(x))
  lp = with(df, 
            0.86215 - 
              0.05343*age + 
              3*10^-5*max(age - 5.0, 0)^3 - 
              6*10^-5*max(age - 30.0, 0)^3 + 
              3*10^-5*max(age - 58.0, 0)^3 - 
              0.8694*ct12)
  return(lp)
}
```

```{r}
# Add the logit contribution from the base model to the dataframe

vars0 <- c('out', 'age', 'ct12')
all_data0 <- data %>% select(all_of(vars0)) # This dataframe includes missing entries

lp0 <- unlist(map(1:nrow(all_data0), function(x) base_model(all_data0[x,])))
data['lp0'] <- lp0
data
```


```{r}
# Plot calibration and ROC plots of the base model

mdl_folder0 <- "model-0"
dir.create(mdl_folder0)

data0 <- all_data0[complete.cases(all_data0),]

pred0 <- unlist(map(1:nrow(data0), function(x) base_model(data0[x,]))) # prediction in log-odds (probabilities on logit scale)
prob0 <- 1 / (1 + exp(-pred0))                                         # prediction as probability response

# Generate the data frame with the data needed for the calibration and ROC plots
plot_data0 <- data.frame(out = data0$out, logodds = pred0, prob = prob0)

cal_plot(base_model, plot_data0, "original", "prob", model_label = '', dir = mdl_folder0, fn = "cal_plot.pdf")
roc_plot(data0$out, prob0, dir = mdl_folder0, fn = "roc_plot.pdf")
```

UPDATED MODEL FOR DAYS 1-2

```{r}
# Apply the Elastic Net variable selecion method on all the lab variables available for days 1-2

sat_imp_formula12 <- '~out+lp0+bun12+alt12+ast12+ck12+alb12+k12+cre12+crp12'

vars12 <- c('out', 'lp0', 'bun12', 'alt12', 'ast12', 'ck12', 'alb12', 'k12', 'cre12', 'crp12')
data12 <- data[vars12]

sel12 <- selectVariables(random_seed, num_imp, sat_imp_formula12, data12, TRUE)

seldf12 <- data.frame(unlist(sel12$names), unlist(sel12$counts))
names(seldf12) <- c("Variable", "Freq")
seldf12
```

```{r}
# Train the model for days 1-2 on the selected variables

mdl_vars12 <- c('lp0', 'alt12', 'ast12', 'ck12', 'bun12', 'k12')

mdl_imp_formula12 <- "~out+lp0+bun12+alt12+ast12+ck12+alb12+k12+cre12+crp12"
mdl_lgr_formula12 <- "out~lp0+bun12+alt12+ast12+ck12+k12"

mdl_folder12 <- "model-days12"
dir.create(mdl_folder12)

model12 <- generateModel(random_seed, num_imp, num_boot, mdl_imp_formula12, mdl_lgr_formula12, data, mdl_vars12, mdl_folder12)
```

```{r}
# Generate the calibration and ROC plots for the models for days 1-2

vars <- append(mdl_vars12, 'out')
df <- data %>% select(all_of(vars))
data12 <- df[complete.cases(df),]

pred12 <- predict(model12, data12) # prediction in log-odds (probabilities on logit scale)
probs12 <- 1 / (1 + exp(-pred12))  # prediction as probability response

# Generate the data frame with the data needed for the calibration and ROC plots
plot_data12 <- data.frame(out = data12$out, logodds = pred12, prob = probs12)

cal_plot(model12, plot_data12, "original", "prob", model_label = '', dir = mdl_folder12, fn = "cal_plot.pdf")
roc_plot(plot_data12$out, plot_data12$prob, dir = mdl_folder12, fn = "roc_plot.pdf")
```


```{r}
# Add the logit contribution from the model for days 1-2 to the dataframe

lp12 <- predict(model12, data)
data['lp12'] <- lp12
```

UPDATED MODEL FOR DAYS 3-4

```{r}
# Apply the Elastic Net variable selecion method on all the lab variables available for days 3-4

sat_imp_formula34 <- '~out+lp12+bun34+alt34+ast34+ck34+alb34+k34+cre34+crp34'

vars34 <- c('out', 'lp12', 'bun34', 'alt34', 'ast34', 'ck34', 'alb34', 'k34', 'cre34', 'crp34')
data34 <- data[vars34]

sel34 <- selectVariables(random_seed, num_imp, sat_imp_formula34, data34, TRUE)

seldf34 <- data.frame(unlist(sel34$names), unlist(sel34$counts))
names(seldf34) <- c("Variable", "Freq")
seldf34
```

```{r}
# Train the model for days 3-4 on the selected variables

mdl_vars34 <- c('lp12', 'alt34', 'ast34', 'ck34', 'cre34', 'k34')

mdl_imp_formula34 <- "~out+lp12+bun34+alt34+ast34+ck34+alb34+k34+cre34+crp34"
mdl_lgr_formula34 <- "out~lp12+alt34+ast34+ck34+cre34+k34"

mdl_folder34 <- "model-days34"
dir.create(mdl_folder34)

model34 <- generateModel(random_seed, num_imp, num_boot, mdl_imp_formula34, mdl_lgr_formula34, data, mdl_vars34, mdl_folder34)
```

```{r}
# Generate the calibration and ROC plots for the models for days 3-4

vars <- append(mdl_vars34, 'out')
df <- data %>% select(all_of(vars))
data34 <- df[complete.cases(df),]

pred34 <- predict(model34, data34) # prediction in log-odds (probabilities on logit scale)
probs34 <- 1 / (1 + exp(-pred34))  # prediction as probability response

# Generate the data frame with the data needed for the calibration and ROC plots
plot_data34 <- data.frame(out = data34$out, logodds = pred34, prob = probs34)

cal_plot(model34, plot_data34, "original", "prob", model_label = '', dir = mdl_folder34, fn = "cal_plot.pdf")
roc_plot(plot_data34$out, plot_data34$prob, dir = mdl_folder34, fn = "roc_plot.pdf")
```

```{r}
# Add the logit contribution from the model for days 1-2 to the dataframe

lp34 <- predict(model34, data)
data['lp34'] <- lp34
```

UPDATED MODEL FOR DAYS 5-6

```{r}
# Apply the Elastic Net variable selecion method on all the lab variables available for days 5-6

sat_imp_formula56 <- '~out+lp34+bun56+alt56+ast56+ck56+alb56+k56+cre56+crp56'

vars56 <- c('out', 'lp34', 'bun56', 'alt56', 'ast56', 'ck56', 'alb56', 'k56', 'cre56', 'crp56')
data56 <- data[vars56]

sel56 <- selectVariables(random_seed, num_imp, sat_imp_formula56, data56, TRUE)

seldf56 <- data.frame(unlist(sel56$names), unlist(sel56$counts))
names(seldf56) <- c("Variable", "Freq")
seldf56
```

```{r}
# Train the model for days 5-6 on the selected variables

mdl_vars56 <- c('lp34', 'bun56', 'ast56')

mdl_imp_formula56 <- "~out+lp34+bun56+alt56+ast56+ck56+alb56+k56+cre56+crp56"
mdl_lgr_formula56 <- "out~lp34+ast56+bun56"

mdl_folder56 <- "model-days56"
dir.create(mdl_folder56)

model56 <- generateModel(random_seed, num_imp, num_boot, mdl_imp_formula56, mdl_lgr_formula56, data, mdl_vars56, mdl_folder56)
```

```{r}
# Generate the calibration and ROC plots for the models for days 5-6

vars <- append(mdl_vars56, 'out')
df <- data %>% select(all_of(vars))
data56 <- df[complete.cases(df),]

pred56 <- predict(model56, data56) # prediction in log-odds (probabilities on logit scale)
probs56 <- 1 / (1 + exp(-pred56))  # prediction as probability response

# Generate the data frame with the data needed for the calibration and ROC plots
plot_data56 <- data.frame(out = data56$out, logodds = pred56, prob = probs56)

cal_plot(model56, plot_data56, "original", "prob", model_label = '', dir = mdl_folder56, fn = "cal_plot.pdf")
roc_plot(plot_data56$out, plot_data56$prob, dir = mdl_folder56, fn = "roc_plot.pdf")
```